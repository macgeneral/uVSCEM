name: Publish

on:
  workflow_run:
    workflows: ["Test"]
    types: [completed]

jobs:
  check:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    outputs:
      should_publish: ${{ steps.release_tag.outputs.should_publish }}
      release_tag: ${{ steps.release_tag.outputs.release_tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - name: Resolve release tag from tested commit
        id: release_tag
        run: |
          TAGS="$(git tag --points-at "${{ github.event.workflow_run.head_sha }}" --list 'v*.*.*')"
          TAG_COUNT="$(echo "${TAGS}" | sed '/^$/d' | wc -l | tr -d ' ')"

          if [[ "${TAG_COUNT}" -eq 0 ]]; then
            echo "No release tag found on tested commit; skipping publish."
            echo "should_publish=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [[ "${TAG_COUNT}" -gt 1 ]]; then
            echo "Expected exactly one release tag on tested commit, found:"
            echo "${TAGS}"
            exit 1
          fi

          RELEASE_TAG="$(echo "${TAGS}" | sed -n '1p')"
          echo "Resolved release tag: ${RELEASE_TAG}"
          echo "release_tag=${RELEASE_TAG}" >> "$GITHUB_OUTPUT"
          echo "should_publish=true" >> "$GITHUB_OUTPUT"

  publish:
    needs: check
    if: ${{ needs.check.outputs.should_publish == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - name: Validate semantic version tag
        run: |
          SEMVER_REGEX='^v[0-9]+\.[0-9]+\.[0-9]+$'
          RELEASE_TAG="${{ needs.check.outputs.release_tag }}"
          if ! [[ "${RELEASE_TAG}" =~ ${SEMVER_REGEX} ]]; then
            echo "Tag ${RELEASE_TAG} is not a valid version tag (expected v<major>.<minor>.<patch> with only numeric parts)"
            exit 1
          fi

      - name: Import tag signing key from GitHub API
        env:
          EXPECTED_SIGNER_GITHUB_LOGIN: ${{ vars.PYPI_TAG_SIGNER_GITHUB_LOGIN }}
        run: |
          if [[ -z "${EXPECTED_SIGNER_GITHUB_LOGIN}" ]]; then
            echo "Missing required variable: PYPI_TAG_SIGNER_GITHUB_LOGIN"
            exit 1
          fi

          python - <<'PY'
          import json
          import os
          import urllib.request

          login = os.environ["EXPECTED_SIGNER_GITHUB_LOGIN"]
          req = urllib.request.Request(
              f"https://api.github.com/users/{login}/gpg_keys",
              headers={"Accept": "application/vnd.github+json", "User-Agent": "uvscem-publish"},
          )

          with urllib.request.urlopen(req) as resp:
              payload = json.load(resp)

          keys = [item.get("armored_public_key", "") for item in payload]
          keys = [key for key in keys if key]
          if not keys:
              raise SystemExit(f"No public GPG keys found for GitHub user: {login}")

          with open("/tmp/tag-signer-keys.asc", "w", encoding="utf-8") as output:
              output.write("\n".join(keys))
              output.write("\n")
          PY

          gpg --batch --import /tmp/tag-signer-keys.asc

      - name: Verify tag signature
        env:
          EXPECTED_SIGNER: ${{ vars.PYPI_TAG_SIGNER }}
        run: |
          RELEASE_TAG="${{ needs.check.outputs.release_tag }}"
          VERIFY_OUTPUT="$(git tag -v "${RELEASE_TAG}" 2>&1)"
          echo "${VERIFY_OUTPUT}"

          echo "${VERIFY_OUTPUT}" | grep -q "Good signature from"

          if [[ -n "${EXPECTED_SIGNER}" ]]; then
            echo "${VERIFY_OUTPUT}" | grep -Fq "${EXPECTED_SIGNER}"
          fi

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: "3.10"

      - name: Install uv
        uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v7.3.0
        with:
          version: "0.10.6"
          checksum: "aaa402e19d14a6b9a4267fcf4ec35380f804c68923525cea67cd6ee05bb4e930"
          enable-cache: true
          cache-dependency-glob: |
            pyproject.toml
            uv.lock

      - name: Install dependencies
        run: uv sync --frozen --group publish

      - name: Build distributions
        run: uv build

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e # v1.13.0
        with:
          attestations: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@6da8fa9354ddfdc4aeace5fc48d7f679b5214090 # v2.4.1
        with:
          tag_name: ${{ needs.check.outputs.release_tag }}
          generate_release_notes: true
          make_latest: true
